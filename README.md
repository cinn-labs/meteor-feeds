# Meteor Feeds
Feeds collection and generator helpers for social networks or any app with events handler

**This package is under development, it is not recommended to use in production**

## How to use it?

### Feeds Collection
This package comes with a preconfigured Feeds collection. It can be imported with ES6 or just use the gloal Feeds variable:
```js
import { Feeds } from 'meteor/cinn:meteor-feeds';
Feeds.find({}); // Return all feeds from DB
```

### Inserting Feeds
Everytime that you want to add a new feed doc to the DB, you need to call the `FeedsHandler.trigger` method on the server, usually inside a method:

```js
import { FeedsHandler } from 'meteor/cinn:meteor-feeds';

Meteor.methods({
  'posts.insert': function(doc) {
    const docId = Posts.insert(doc);
    FeedsHandler.trigger('posts', 'inserted', this.userId, { docId });
  }
})

Meteor.userId(); // 1
Meteor.call('posts.insert', { name: 'Test' });
```

This will automatically insert a new feed document in the database, with these fields:
```js
{
  _id: 'autoGeneratedId',
  namespace: 'posts',
  key: 'inserted',
  userId: '1',
  docId: 'docIdPassedAsParam',
  involvedUsersIds: ['1'],
  data: {}
}
```

The trigger function can receive the fowlling params:
```js
FeedsHandler.trigger(namespace, key, userId, customParams);
```
 - `namespace`:  Primary indentifier for the type of feed, this field combined with the `key` can be used to customize the feeds presentation and behavior.

 - `key`: Secondary indetifier, this field combined with the `key` can be used to customize the feeds presentation and behavior.

 - `userId`: Id of the user involved in the action, usualy is the logged user.

 - `customParams`: Any data that is relevant for the presentation and behavior of the feed. If is provided a docId, it will be saved on the DB, the other params provided in this objective must be treated individually.

**The namespace and the key are saved as separeted fields to facilitate the queries, but they are used together.**

### Feeds events life cycle
**Everytime that we say `feed type`, is the combination of `namespace` and `key`, used to differentiate the feeds.**

Every time the you insert a feed using the `FeedsHandler.trigger` function, it will pass for this events hooks (in the same order):
 - `data`: This is the place where you can configure custom params to save for each feed type
 - `involvedUsersIds`: Each feed type can have some involvedUsers besides the user that called the trigger.
 - `mail`: If you want to send emails when some feeds is created, this is the place
 - `before`: Logic that runs before the feed is inserted to the database
 - `after`: Logic that runs after the feed is inserted to the database


## Customizing the feeds behavior and life cycle

### Customizing the data

If you just want to create a feed and don't have to customize anything, you can just call the `trigger` function and everything will be done for you. But if you would like to customize something, for example you want to save the post title in the feed to optimize the performance, you can do it like this:

```js
Meteor.methods({
  'posts.insert': function(doc) {
    const docId = Posts.insert(doc);
    FeedsHandler.trigger('posts', 'inserted', this.userId, { docId });
  }
})

// On the server
FeedsHandler.bulkAdd({
  'posts.inserted': {
    data({ docId, userId }) {
      const doc = Posts.findOne({ _id: docId });
      return { postTitle: doc.title };
    }
  }
})

Meteor.userId() // 1
Meteor.call('posts.insert', { name: 'Test' });
Feeds.findOne().data.postTitle; // 'Test'
```

The `FeedsHanler.bulkAdd` function is configured in similar way of the meteor methods, each key of the object is the `namespace`.`key`. And each object passed to the feed type name, can receive each of the lifecyles events hooks (data, involvedUsersIds, mail, before, after);


### Customizing the involvedUsersIds

The involvedUsersIds hook works very similar to the `data` hook, the returned array of this hook will be saved to the database as `feed.involvedUsersIds`:

```js
Meteor.methods({
  'message.send': function(doc) {
    const docId = Posts.insert(doc);
    FeedsHandler.trigger('messages', 'sent', this.userId, { docId });
  }
})

// On the server
FeedsHandler.bulkAdd({
  'messages.sent': {
    involvedUsersIds({ docId, userId, data }) {
      const doc = Messages.findOne({ _id: docId });
      return [doc.toUserId];
    }
  }
})

Meteor.userId(); // 1
Meteor.call('message.send', { value: 'Test', toUserId: '3' });
Feeds.findOne().involvedUsersIds; // [1, 3]
```

The userId passed on the trigger call will be automatically concated with the return of the involvedUsersIds hook.

Since the data hook runs before this, you can access the values set to the data on this hook.

The `FeedsHanler.bulkAdd` function is configured in similar way of the meteor methods, each key of the object is the `namespace`.`key`. And each object passed to the feed type name, can receive each of the lifecyles events hooks (data, involvedUsersIds, mail, before, after);

### Mail, Before and After

The `mail`, `before` and `after` hooks are just functions that runs in the same order:

```js
Meteor.methods({
  'message.send': function(doc) {
    const docId = Posts.insert(doc);
    FeedsHandler.trigger('messages', 'sent', this.userId, { docId });
  }
})

// On the server
FeedsHandler.bulkAdd({
  'posts.inserted': {
    mail({ docId, userId, data }) {
      // Send the email
    },
    
    before({ docId, userId, data }) {
      // Logic before insert
    },
    
    after({ docId, userId, data }) {
      // Logic after insert
    }
  }
})
```
Since the data hook runs before this, you can access the values set to the data on this hook.

The `FeedsHanler.bulkAdd` function is configured in similar way of the meteor methods, each key of the object is the `namespace`.`key`. And each object passed to the feed type name, can receive each of the lifecyles events hooks (data, involvedUsersIds, mail, before, after);
